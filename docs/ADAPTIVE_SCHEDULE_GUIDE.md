# 自适应日程系统使用指南

## 概述

本系统实现了"自适应粒度 + 单一数据源"的最优方案，让首页任务规划和固定日程无缝协作。

## 核心特性

### 1. 统一的分钟级时间精度

- **数据层**：所有任务的 `startTime` 和 `endTime` 统一使用 `HH:mm` 格式，支持任意分钟精度（如 `09:07`、`14:23`）
- **单一数据源**：首页和固定日程共享同一套任务数据，不存在"双时间"问题
- **排期标记**：任务通过 `scheduledDate` 和 `isScheduled` 字段标记是否已排期

### 2. 自适应时间刻度

固定日程的时间轴会根据当前任务的实际粒度自动调整：

| 任务时间特征 | 自动刻度 | 说明 |
|------------|---------|------|
| 全部整点（09:00, 10:00） | 1小时 | 视图简洁，适合粗排 |
| 包含半小时（09:30） | 30分钟 | 中等密度 |
| 包含15分钟（09:15, 09:45） | 15分钟 | 较细密度 |
| 包含任意分钟（09:07, 14:23） | 5分钟 | 最细密度，支持精确排期 |

**优势**：
- 无需手动缩放，系统自动适配
- 粗排时视图清爽，细排时精度足够
- 辅助刻度线自动显示，帮助对齐

### 3. 智能建议对齐

- **鼠标悬停提示**：当鼠标悬停在时间格子上时，会高亮显示"建议"标记
- **保留精确时间**：从首页拖拽任务到固定日程时，默认保留原始分钟时间（如 09:07）
- **快捷对齐**（计划中）：
  - 双击任务边缘可快速对齐到整点/半小时/15分钟
  - 批量整理工具可一键对齐所有任务

### 4. 周视图支持

- 按周显示，每天一列
- 每列独立计算自适应刻度（周一可能是小时级，周二可能是15分钟级）
- 支持跨天任务（自动拆分显示）

## 数据结构

### SimpleTask 类型（首页任务）

```typescript
export type SimpleTask = {
    id?: number;
    taskTime?: string;        // YYYY-MM-DD
    startTime?: string;       // HH:mm 分钟精度（如 09:07）
    endTime?: string;         // HH:mm 分钟精度（如 09:35）
    task?: string;
    remark?: string;
    state?: 'pending' | 'in-progress' | 'completed' | 'delayed';
    
    // 排期标记
    scheduledDate?: string;   // 已排期的日期 YYYY-MM-DD
    isScheduled?: boolean;    // 是否已排期
    
    // 其他字段...
};
```

### Task 类型（固定日程任务）

与 `SimpleTask` 共享相同的时间字段格式，确保数据一致性。

## 使用流程

### 1. 在首页规划任务

```typescript
// 任务可以按分钟拆分
const task = {
    task: "完成需求文档",
    startTime: "09:07",  // 支持任意分钟
    endTime: "09:35",
    // ...
};
```

### 2. 添加到固定日程

```typescript
// 点击"加入日程"按钮
handleAddToSchedule(task);

// 任务会被添加到固定日程，时间保持 09:07-09:35
// 同时标记 scheduledDate 和 isScheduled
```

### 3. 在固定日程中查看

- 固定日程会自动检测所有任务的时间粒度
- 如果有 `09:07` 这样的任务，刻度自动降到 5 分钟
- 任务块精确显示在对应的分钟位置

### 4. 在固定日程中调整

- 拖拽任务块可调整时间
- 拉伸任务块边缘可调整时长
- 修改后的时间会同步回首页（因为是同一数据源）

## 组件使用

### AdaptiveCalendar（新增）

```tsx
import AdaptiveCalendar from '@/src/views/schedule/components/AdaptiveCalendar';

<AdaptiveCalendar
    tasks={tasks}
    currentDate={moment()}
    isPastWeek={false}
    onEditTask={handleEdit}
    onAddTask={handleAdd}
    workHoursSettings={workHours}
/>
```

**特性**：
- 自动计算时间刻度
- 显示辅助刻度线
- 支持鼠标悬停建议
- 任务块精确定位

### 工具函数

```typescript
import {
    getAdaptiveTimeScale,
    suggestAlignedTime,
    calculateTaskPosition
} from '@/src/views/schedule/utils/adaptiveTimeScale';

// 获取自适应刻度
const scale = getAdaptiveTimeScale(tasks);
// => { granularity: '15min', interval: 15, label: '15分钟' }

// 计算建议对齐时间
const aligned = suggestAlignedTime('09:07', 15);
// => '09:00' 或 '09:15'（取最近的）

// 计算任务位置
const pos = calculateTaskPosition('09:07', '09:35', 60, 15, '09:00');
// => { top: 28px, height: 112px }
```

## 最佳实践

### 1. 首页规划阶段

- 按实际需要的粒度拆分任务（分钟/小时都可以）
- 不用担心"太细"，固定日程会自动适配

### 2. 固定日程排期阶段

- 系统会自动选择合适的刻度
- 如果觉得太密集，可以手动调整任务时间到整点/半小时
- 使用"批量整理"工具（计划中）快速对齐

### 3. 混合使用

- 可以同时有整点任务（10:00-11:00）和分钟任务（09:07-09:35）
- 系统会自动选择最细的刻度来适配所有任务

## 后续优化计划

1. **拖拽优化**
   - 支持从首页直接拖拽任务到固定日程的具体时间格
   - 拖拽时显示实时预览和建议对齐线

2. **快捷对齐**
   - 双击任务边缘弹出对齐菜单
   - 批量整理工具

3. **冲突检测增强**
   - 实时显示时间冲突
   - 自动建议可用时间段

4. **视图切换**
   - 支持日视图/周视图/月视图切换
   - 每种视图独立的刻度策略

## 技术细节

### 刻度检测算法

```typescript
// 扫描所有任务的 startTime 和 endTime
// 检查分钟部分是否能被 60/30/15/5/1 整除
// 选择最小的可整除粒度作为刻度
```

### 任务定位算法

```typescript
// 基于基准时间（如 09:00）
// 计算任务开始时间的偏移分钟数
// 根据刻度间隔和槽高度计算像素位置
top = (offsetMinutes / slotInterval) * slotHeight
height = (durationMinutes / slotInterval) * slotHeight
```

### 数据同步

- 首页和固定日程使用相同的 `tasks` 数组
- 任何一方修改时间，另一方自动同步
- 通过 `scheduledDate` 标记区分"已排期"和"未排期"

## 常见问题

**Q: 为什么固定日程的刻度会自动变化？**  
A: 系统会根据当前所有任务的时间粒度自动选择最合适的刻度，确保所有任务都能精确显示。

**Q: 如果我想强制使用小时刻度怎么办？**  
A: 确保所有任务的时间都是整点（如 09:00, 10:00），系统会自动使用小时刻度。

**Q: 从首页拖任务到固定日程，时间会被改变吗？**  
A: 不会。时间会保持原样（如 09:07），除非你手动调整。

**Q: 首页和固定日程的数据会不一致吗？**  
A: 不会。它们共享同一数据源，任何修改都会双向同步。

## 总结

这套系统的核心优势是：

✅ **数据一致性**：单一时间源，绝对不会出现数据分裂  
✅ **交互直观**：所见即所得，不强制吸附  
✅ **视图自适应**：该粗则粗、该细则细，自动适配  
✅ **扩展性强**：容易支持更多场景和功能

使用时只需记住：**按实际需要拆分任务，系统会自动处理其余一切**。
