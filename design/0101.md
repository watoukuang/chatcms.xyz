# **AITODO.ME – 需求整理**
这是一个基于AI的任务拆分与任务协作平台。核型价值：将用户输入的一句话目标 → 转换为 TODO 任务链 → 安排日程 → 交给市场用户或智能应用执行。系统围绕以下三项核心能力设计:
- AI自动任务拆分
- 智能日程管理
- 协作与任务执行（任务市场 + 智能应用）

## **用户体系与权限模型**

| 功能              | 未登录用户          | 登录用户   |
| --------------- | -------------- | ------ |
| 使用 AI 生成 TODO   | ✔（需配置 API Key） | ✔      |
| 使用系统内置模型        | ✖              | ✔      |
| 添加任务到固定日程       | ✔              | ✔      |
| 使用灵活备选          | ✔              | ✔      |
| 使用智能应用（检测 & 调用） | ✔              | ✔      |
| 发布任务到任务市场       | ✖              | ✔（需登录） |
| 浏览任务市场          | ✔              | ✔      |
| 提交自己的智能应用       | ✔              | ✔      |
| 配置模型与 API Key   | ✔              | ✔      |

**关键逻辑（现状与约束）：**

- 未登录用户可以使用 AI 生成功能与本地数据能力，但不得进行跨用户行为（如发布到市场、付费相关操作）。
- 前端当前实现采用本地存储与事件驱动的轻量认证模型：`token` 与 `user_detail` 存储于浏览器（见 `src/shared/api/auth.ts`、`src/shared/hooks/useAuth.ts`）。
- 权限守卫目前以前端占位（`useAccess` 默认返回允许）为主，后端强校验需要在接口层补齐；文档在此明确：跨用户行为必须由服务端进行鉴权与授权校验。

### 角色与标识

- 访客（Guest）：未登录；拥有本地数据访问与个人使用能力；不可进行跨用户写操作。
- 注册用户（User）：完成登录；拥有跨用户行为权限（市场发布、个人资料、智能应用管理等）。
- 可选计划（会员/订阅）：目前前端显示为占位（`useAccess` 返回 `isPaidPlan: true`），尚未落地付费能力；权限划分按下文“会员访问控制”规划。

### 认证模型与 Token 生命周期（前端视角）

- 登录成功写入：`token`（JWT）与 `user_detail` 至本地存储；触发全局事件 `authChanged`。
- 有效性校验：`useAuth.isTokenValid()` 解析 JWT `exp` 字段进行过期判断；过期时清除本地缓存并降级为访客态。
- 登出：本地清理 `token` 与 `user_detail`，并触发 `authChanged`（目前不调用服务端接口，需在后端补齐会话失效）。

### 存储与事件

- 本地键：`token`、`user_detail`（见 `src/shared/utils/storage`）。
- 事件驱动：登录/登出均派发 `window.dispatchEvent(new Event('authChanged'))`，`useAuth` 监听并刷新认证状态；跨标签页通过 `storage` 事件保持一致。

### 权限矩阵与守卫点（需要后端强校验）

| 行为 | 守卫点（前端） | 守卫点（后端） | 说明 |
| --- | --- | --- | --- |
| 任务市场发布 | 登录态检查（弹登录框） | JWT 校验 + 作者归属 | 访客禁止；接口需校验 `token` 与发布者 ID |
| 智能应用提交 | 登录态检查 | JWT 校验 + 配额检查 | 防止匿名提交污染数据 |
| 模型使用（系统内置） | `Access` 组件/开关 | 订阅状态校验 | 免费用户不可用系统内置模型，仅自定义 API Key |
| 个人资料修改 | 登录态检查 | JWT 校验 + 资源归属 | 仅本人可改 |
| 市场浏览 | 不限制 | 不限制 | 只读 |

> 注：当前 `useAccess` 返回“始终允许”，为占位实现；上线前必须将前端守卫改为真实判断，并由后端在接口层做最终裁决。

### 未登录能力边界（细化）

- 允许：AI 生成功能、自定义 API Key、固定日程与备选的本地操作（不涉及他人数据）。
- 禁止：任何会影响其他用户或公共数据的写操作（发布、评论、共享、付费）。

### 第三方登录（占位）

- 登录弹窗中保留 Google OAuth 入口：`NEXT_PUBLIC_GOOGLE_OAUTH_URL`；实际 OAuth 流程需在后端与页面路由层打通。

### 会员访问控制（规划）

- 免费版：仅允许使用 POW（示例来源于 `pricing` 页面），以及自定义 API Key 的 AI 生成功能。
- 付费版：可访问全部高级功能（包括系统内置模型、扩展市场能力、智能应用高级配额）。
- 前端侧：`useAccess` 改造为根据用户的 `vip` 或订阅状态返回权限；`Access` 组件在页面/组件级做包裹。
- 后端侧：接口根据用户订阅状态进行授权裁决，避免越权访问。

### 安全与合规

- 最小化存储：仅存储 JWT 与必要的用户资料，避免在本地持久化敏感信息。
- 过期处理：JWT 过期自动清理并下线；所有写接口需校验 `exp`。
- CSRF/重放：跨站写接口采用 Bearer Token + 服务器侧校验；必要时引入一次性操作令牌。
- 隐私声明：登录/注册弹窗已提示“同意用户协议与隐私政策”，需在站内提供具体条款入口。

### 开发规范与接口契约（建议）

- `/api/auth/login`：返回 `{ token, user_detail, expiresIn }`；`user_detail` 至少包含 `{ id, email, vip }`。
- `/api/auth/register`：成功返回 `{ success: true }`，失败返回标准错误结构。
- `/api/auth/logout`：使服务端会话失效（当前前端仅本地清理，需补齐）。
- 错误返回格式统一：`{ success, code, message, data }`。


---

# **三、系统核心功能结构（模块分解）**

系统由六大核心模块组成：

1. **任务执行（AI 生成与任务链画布）**
2. **固定日程（主任务执行计划）**
3. **灵活备选（任务池）**
4. **任务市场（用户协作）**
5. **智能应用（用户自定义智能体）**
6. **全局设置（模型、API Key、工作时间）**

此外还有两个辅助系统功能：

* 主题切换（深色/浅色）
* 用户登录/注册

---

# **四、模块级需求说明**

---

## **1. 任务执行（核心入口）**

这是用户进入产品后最先接触的页面，功能逻辑如下：

### **1.1 页面构成**

* 左侧：历史会话列表
* 右侧：任务链画布（核心）
* 底部：Chat 输入框

### **1.2 主流程**

用户输入一句任务提示文案，例如“准备部门团建”。
➡ 系统调用 AI 模型
➡ 输出一个 TODO 列表集合
➡ 展示在任务链画布中

### **1.3 任务链画布展示逻辑**

* 每个 TODO 以卡片形式呈现
* 任务间使用连线表示顺序/依赖关系（TODO1 → TODO2）
* 卡片支持：

  * 编辑文本
  * 点击进入“任务详情抽屉”
  * 调用 AI 为当前任务生成子任务
  * 设置父子任务关联关系
  * 拖拽改变位置

### **1.4 子任务生成交互（重点逻辑）**

用户点击某个 TODO → 打开任务详情 → 点击「进一步拆分」
➡ 系统生成子任务列表
➡ 子任务自动关联「父 TODO」
➡ 在画布中以树状或层级连线方式展示

**规则：**

* 子任务不可直接脱离父任务加入日程，需要由父级管理
* 可单独编辑、删除、再次细分

### **1.5 顶部画布操作按钮**

#### （1）加入日程

* 将该任务（或任务组）加入固定日程
* 系统自动检查时间冲突
* 冲突时给予提示并阻止操作

#### （2）加入备选

* 将当前生成的“整组任务链”加入灵活备选
* 适用于短期无法排期但想保存的任务集

---

## **2. 固定日程（主执行视图）**

### **2.1 展示方式**

* 以周视图为主
* 每天以卡片时段方式展示任务
* 用户可自由浏览与跳转

### **2.2 任务创建/编辑逻辑**

* 点击空白卡片 → 创建新任务
* 点击已有任务 → 打开任务详情
* 点击“解锁” → 进入编辑模式（防误触）

### **2.3 发布到任务市场**

用户编辑任务时，如果认为自己无法执行 → 点击“发布到市场”

规则：

1. 登录用户：允许发布
2. 未登录用户：弹出登录提示
3. 已发布的任务会出现在任务市场

---

## **3. 灵活备选（任务池）**

### **3.1 用途**

存放无法立即加入日程的任务集（由任务生成画布添加而来）。

### **3.2 功能逻辑**

* 展示一个个“任务卡片集合”
* 可查看任务详情
* 可随时将卡片集合导入日程
* 导入前系统会再次检查时间冲突

---

## **4. 任务市场**

### **4.1 功能定位**

用户将无法完成或希望外包的任务发布到市场，让其他用户接单。

### **4.2 市场页面功能**

* 浏览任务列表
* 查看任务详情
* 展示联系方式/沟通方式
* 用户可自行联系任务发布人（系统不做中介流程）

### **4.3 限制**

* 未登录用户无法发布
* 浏览任务市场不需要登录

---

## **5. 智能应用（AI 智能体管理）**

### **5.1 功能说明**

用户可以创建自己的智能体（例如邮件助手、内容生成机器人）。

### **5.2 页面组成**

* 智能应用列表
* 新增智能体的表单（输入 API、描述、功能定义等）

### **5.3 TODO 匹配逻辑**

在任务详情中用户有一个“检查”按钮：

流程：

1. 用户点击“检查”
2. 系统分析当前 TODO 内容
3. 从智能应用中筛选可处理当前任务的智能体
4. 如果存在匹配 → 提供调用入口
5. 如果不存在 → 提示“暂无可用智能应用”

---

## **6. 全局设置**

### **可设置项**

* 模型选择（如 GPT、Claude、Llama 等）
* 自定义 API Key（未登录也可使用）
* 工作时间（用于智能日程安排）
* 主题切换（与顶部控件同步）
* 用户账户相关设置

---

# **五、关键业务规则（非常重要）**

### **5.1 时间冲突算法**

加入日程时，系统需校验：

* 同一天同一时间段是否已有任务
* 是否有跨任务的持续时间重叠
* 子任务不能安排早于父任务结束时间（如有依赖关系）

### **5.2 登录限制规则**

* 未登录只允许本地、非跨用户行为
* 若尝试发布任务 → 强制登录
* 未登录用户可使用自定义 API Key 完整使用 AI 功能

### **5.3 任务链与子任务规则**

* 子任务必须属于某个父任务
* 子任务可再次拆分
* 子任务加入日程时需遵循父级优先逻辑
* 删除父任务需提示是否同时删除子任务

### **5.4 智能应用匹配逻辑**

* 以任务文本关键词/意图为基础
* 采用简单分类或 LLM 分析匹配
* 多个应用同时满足时，用户可选择一个

---

# **六、整体用户流程（逻辑链路）**

```
输入目标 → AI 生成任务链 → 画布展示 → 加入日程 / 加入备选
                  ↓
              固定日程 → 发布到市场 / 执行任务
                  ↓
              智能应用 → 自动处理部分任务
                  ↓
             用户持续迭代任务链与日程
```

---

# **七、最终总结（逻辑结构化）**

本需求整理遵循以下逻辑结构：

1. **任务输入 → AI 拆分 → 任务画布 → 子任务拆分**
2. **任务画布 → 固定日程 / 灵活备选**
3. **固定日程 → 用户执行 / 任务市场外包**
4. **任务详情 → 智能应用匹配与自动执行**
5. **未登录用户可用 AI，跨用户协作必须登录**

整个体系形成一套完整闭环：
**目标 → 任务 → 时间 → 执行方式（自做/市场/智能体）**

---

如果你需要，我可以继续为你：

📌 **生成完整 PRD（包含用户故事、接口需求、业务流程图）**
📌 **生成可直接导出的 PDF（专业排版版 / Markdown 版 / Word 版）**
📌 **画出所有模块的系统架构图、流程图、任务链交互图**

需要继续吗？
